"use strict";(globalThis.webpackChunkinvictus_integration=globalThis.webpackChunkinvictus_integration||[]).push([[4900],{7056(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"support/v6-migration","title":"Migrating to Invictus for Azure v6","description":"In v6 we uses containerized API\'s instead of Web API\'s and Azure Functions. This means that the endpoints for the Dashboard and API\'s such as the PubSub and Transco components changes.","source":"@site/versioned_docs/version-v6.0.0/support/v6-migration.md","sourceDirName":"support","slug":"/support/v6-migration","permalink":"/support/v6-migration","draft":false,"unlisted":false,"editUrl":"https://github.com/invictus-integration/docs-ifa/edit/master/docs/versioned_docs/version-v6.0.0/support/v6-migration.md","tags":[],"version":"v6.0.0","frontMatter":{"sidebar_label":"Migrating to v6","pagination_prev":null,"pagination_next":null},"sidebar":"sidebar"}');var s=i(4848),t=i(8453);const o={sidebar_label:"Migrating to v6",pagination_prev:null,pagination_next:null},a="Migrating to Invictus for Azure v6",c={},l=[{value:"Preparing Environment",id:"preparing-environment",level:2},{value:"Deploying New Version",id:"deploying-new-version",level:2},{value:"After Deployment",id:"after-deployment",level:2},{value:"Common Migration Issues",id:"common-migration-issues",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components},{Details:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"migrating-to-invictus-for-azure-v6",children:"Migrating to Invictus for Azure v6"})}),"\n",(0,s.jsx)(n.admonition,{title:"change of endpoints",type:"warning",children:(0,s.jsx)(n.p,{children:"In v6 we uses containerized API's instead of Web API's and Azure Functions. This means that the endpoints for the Dashboard and API's such as the PubSub and Transco components changes."})}),"\n",(0,s.jsxs)(n.admonition,{title:"removal of v1 Framework components",type:"danger",children:[(0,s.jsx)(n.p,{children:"The PubSub v1, Transco v1 and Matrix v1 components are not available anymore in v6."}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/framework/pubsubV2#migrating-pubsub-v1-to-v2",children:"Migrating PubSub v1 to v2"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/framework/transcoV2#migrating-transco-v1-to-v2",children:"Migrating Transco v1 to v2"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/framework/transcoV2#migrating-transco-v1-to-v2",children:"Migrating Matrix v1 to Transco v2"})}),"\n"]})]}),"\n",(0,s.jsx)(n.h2,{id:"preparing-environment",children:"Preparing Environment"}),"\n",(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:(0,s.jsx)("h3",{style:{margin:0},children:"Create new Azure DevOps variable libraries for Invictus for Azure v6"})}),(0,s.jsxs)(n.p,{children:["Create new/independent ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/devops/pipelines/library/?view=azure-devops",children:"Azure DevOps variable libraries"})," to support the coexistence of both old and new versions in the same environment and to ease the migration from one to the other."]}),(0,s.jsx)(n.admonition,{title:"example",type:"note",children:(0,s.jsxs)(n.p,{children:["If you have a library with the name ",(0,s.jsx)(n.code,{children:"invictus.{environment}"})," create a new one with the name ",(0,s.jsx)(n.code,{children:"invictus.containerized.{environment}"})," and change your Invictus for Azure pipelines to use the new libraries."]})})]}),"\n",(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:(0,s.jsx)("h3",{style:{margin:0},children:"Create an application registration in Azure Active Directory/Entra ID"})}),(0,s.jsxs)(n.p,{children:["Go to Azure Active Directory/Entra ID and ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/entra/identity-platform/quickstart-register-app",children:"create a new application registration"})," for the Invictus for Azure API's. ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/app-service/configure-authentication-provider-aad",children:"Authentication with the Invictus for Azure API's"})," happens via this application."]}),(0,s.jsx)(n.p,{children:"Create a new client secret for this application (and save it, as you will need it later)."})]}),"\n",(0,s.jsx)(n.h2,{id:"deploying-new-version",children:"Deploying New Version"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:i(8188).A+"",children:(0,s.jsxs)("h3",{style:{margin:0},children:["\u2b07\ufe0f Download latest version of ",(0,s.jsx)(n.code,{children:"Invictus-GetSources.ps1"})]})})}),"\n",(0,s.jsx)(n.p,{children:"Pipeline/Bicep parameters changes, please follow the installation guides to see the current supported parameters:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/dashboard/installation/",children:"Dashboard installation guide"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/framework/installation/",children:"Framework installation guide"})}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{title:"considerations",type:"warning",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Pipelines now requires Ubuntu agent."}),"\n",(0,s.jsxs)(n.li,{children:["Components are using Azure Container Apps:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/container-apps/scale-app?pivots=container-apps-bicep",children:"App Scaling"}),": verify if our default app scaling parameters match your need."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/container-apps/revisions",children:"Multiple Revision mode"}),": older revisions could clutter environment. Consider using our ",(0,s.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:i(2049).A+"",children:"revisions clean-up script"})," in an Azure DevOps pipeline."]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(n.h2,{id:"after-deployment",children:"After Deployment"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/dashboard/installation/give_la_access",children:"\ud83d\udee1\ufe0f Give Invictus access to client's Azure Logic Apps"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/entra/identity-platform/how-to-add-redirect-uri",children:"\ud83d\udd00 Update redirect URLs of the app registration"})," (Azure Active Directory/Entra ID login into the Dashboard needs the new Dashboard Gateway URL.)"]}),"\n"]}),"\n",(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:(0,s.jsx)("h3",{style:{margin:0},children:"Update your Azure Logic Apps parameters files"})}),(0,s.jsx)(n.p,{children:"Make sure to update your Logic App parameters files to represent the new components."}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",children:'"invictus": {\n    "value": {\n        "monitoring": {\n            "eventHub": {\n                "name": "#{Invictus.Monitoring.EventHub.Name}#",\n                "accessRuleId": "#{Invictus.Monitoring.EventHub.AccessRuleId}#"\n            }\n        },\n        "framework": {\n            "pubSub": {\n-               "v1": {\n-                   "definitionUrl": "#{Invictus.Framework.PubSub.V1.DefinitionUrl}#",\n-                   "publishUrl": "#{Invictus.Framework.PubSub.V1.PublishUrl}#",\n-                   "subscribeUrl": "#{Invictus.Framework.PubSub.V1.SubscribeUrl}#",\n-                   "acknowledgeUrl": "#{Invictus.Framework.PubSub.V1.AcknowledgeUrl}#"\n-                }\n+               "v2": {\n+                   "publishUrl": "#{Invictus.Framework.PubSub.V2.Publish.Url}#",\n+                   "subscribeUrl": "#{Invictus.Framework.PubSub.V2.Subscribe.Url}#",\n+                   "acknowledgeUrl": "#{Invictus.Framework.PubSub.V2.Acknowledge.Url}#"\n+\t\t\t    }   \n            },\n-           "matrix": {\n-               "v1": {\n-                   "definitionUrl": "#{Invictus.Framework.Matrix.V1.DefinitionUrl}#",\n-                   "matrixUrl": "#{Invictus.Framework.Matrix.V1.MatrixUrl}#",\n-                   "basicMatrixUrl": "#{Invictus.Framework.Matrix.V1.BasicMatrixUrl}#"\n-               }\n-           },\n            "transco": {\n-               "v1": {\n-                   "definitionUrl": "#{Invictus.Framework.Transco.V1.DefinitionUrl}#",\n-                   "transcoUrl": "#{Invictus.Framework.Transco.V1.TranscoUrl}#"\n-               }\n+               "v2": {\n+                   "transcoJsonUrl": "#{Invictus.Framework.Transco.V2.TranscoJson.Url}#",\n+                   "transcoXmlUrl": "#{Invictus.Framework.Transco.V2.TranscoXml.Url}#",\n+                   "basicMatrixUrl": "#{Invictus.Framework.Transco.V2.MatrixBasicPromote.Url}#"\n+\t\t\t    }\n            }\n        },\n+       "authentication": {\n+   \t\t"audience": "api://#{Invictus.Containers.Client.Id}#"\n+\t    }\n    }\n}\n'})})]}),"\n",(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:(0,s.jsx)("h3",{style:{margin:0},children:"Update your Azure Logic Apps Invictus API authentication"})}),(0,s.jsxs)(n.p,{children:["The Invictus for Azure API's now requires an access token in the ",(0,s.jsx)(n.code,{children:"Authorization"})," header of the HTTP request instead of a function key. Implement this on the HTTP action in your Logic App as follows:"]}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'"authentication": {\n    "audience": "[parameters(\'invictus\').authentication.audience]",\n    "identity": "[parameters(\'infra\').managedIdentity.id]",\n    "type": "ManagedServiceIdentity"\n}\n'})}),(0,s.jsxs)(n.p,{children:["In this example we are using a user assigned managed identity (of which we have specified the application ID in the ",(0,s.jsx)(n.code,{children:"customApplicationIds"})," in the Invictus for Azure pipelines) and using the application id from the newly created app registration as the audience."]}),(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsx)(n.p,{children:"Invictus for Azure user assigned managed identity can be auto-created, but keep in mind that Logic Apps only supports a single user assigned managed identity. If you already have one in your environment make sure to keep using that one."})})]}),"\n",(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:(0,s.jsx)("h3",{style:{margin:0},children:"Remove old/unused Azure resources"})}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-dashboard"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-dashboardgateway"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-cacheimportjob"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-database-storeimportjob"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-datafactoryreceiver"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-flowhandlerjob"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-invictusimportjob"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-storeimportjob"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-appplan-linux"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-importjobappins"})}),"\n"]}),(0,s.jsx)(n.p,{children:"After migrating your Azure Logic Apps to Invictus for Azure v6, you can also remove the following resources:"}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-matrixapp"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-pubsubapp"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-transcoapp"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-exceptionhandler"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-genericreceiver"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-httpreceiver"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-pubsub-v2"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-timesequencer"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-regextranslator"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-sequencecontroller"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-transco-v2"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-xmljsonconverter"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-xsdvalidator"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-appplan"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"invictus-{prefix}-consumptionplan"})}),"\n"]})]}),"\n",(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:(0,s.jsx)("h3",{style:{margin:0},children:"Remove lingering role assignments"})}),(0,s.jsxs)(n.p,{children:["The v6 installation will result in many lingering role assignments named ",(0,s.jsx)(n.code,{children:"Unknown"}),". You can delete them."]})]}),"\n",(0,s.jsx)(n.h2,{id:"common-migration-issues",children:"Common Migration Issues"}),"\n",(0,s.jsxs)(n.admonition,{type:"danger",children:[(0,s.jsxs)(n.mdxAdmonitionTitle,{children:["pipeline error: ",(0,s.jsx)(n.code,{children:"Operating system not supported"})]}),(0,s.jsxs)(n.p,{children:["Your release pipeline agent must be a linux agent, for example ",(0,s.jsx)(n.code,{children:"vmImage: 'ubuntu-latest'"})]})]}),"\n",(0,s.jsxs)(n.admonition,{type:"danger",children:[(0,s.jsxs)(n.mdxAdmonitionTitle,{children:["Pipeline Error: ",(0,s.jsx)(n.code,{children:"Invalid ContainerApp name....The length must be between 2 and 32 characters inclusive."})]}),(0,s.jsx)(n.p,{children:"If you are overriding the default app names, the provided name might be too long, as the Azure Container App name limit is lower than for function apps."})]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8188(e,n,i){i.d(n,{A:()=>r});const r=i.p+"assets/files/Invictus-GetSources-ea2dec1cf7740cb8b796e7741a80dda7.ps1"},2049(e,n,i){i.d(n,{A:()=>r});const r=i.p+"assets/files/Invictus-RemoveOldRevisions-9db10d3ab82759e4553432e01652f09e.ps1"},8453(e,n,i){i.d(n,{R:()=>o,x:()=>a});var r=i(6540);const s={},t=r.createContext(s);function o(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);