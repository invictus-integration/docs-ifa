"use strict";(globalThis.webpackChunkinvictus_integration=globalThis.webpackChunkinvictus_integration||[]).push([[5046],{2960(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"framework/sequencecontroller","title":"Run Logic App workflows in sequence by indexing with the <u>Sequence Controller</u>","description":"Some dependent external systems can\'t handle parallel message processing or requires a certain order of messages. Sending messages serially (for example, by setting the concurrency on a Logic App to 1) can be a solution, at the cost of a big performance impact.","source":"@site/versioned_docs/version-v6.0.0/framework/sequencecontroller.md","sourceDirName":"framework","slug":"/framework/sequencecontroller","permalink":"/framework/sequencecontroller","draft":false,"unlisted":false,"editUrl":"https://github.com/invictus-integration/docs-ifa/edit/master/docs/versioned_docs/version-v6.0.0/framework/sequencecontroller.md","tags":[],"version":"v6.0.0","frontMatter":{"sidebar_label":"Index-controlled sequence"},"sidebar":"sidebar","previous":{"title":"Regex replacements","permalink":"/framework/regextranslation"},"next":{"title":"Time-controlled sequence","permalink":"/framework/timesequencer"}}');var r=s(4848),o=s(8453);const i={sidebar_label:"Index-controlled sequence"},c="Run Logic App workflows in sequence by indexing with the Sequence Controller",l={},a=[{value:"Available endpoints",id:"available-endpoints",level:2},{value:"\u2b05\ufe0f Get sequence number",id:"\ufe0f-get-sequence-number",level:2},{value:"\u231b Wait for sequence",id:"-wait-for-sequence",level:2},{value:"\u2611\ufe0f Complete sequence",id:"\ufe0f-complete-sequence",level:2},{value:"\ud83d\udd04 Reset sequence",id:"-reset-sequence",level:2},{value:"Customization",id:"customization",level:2}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components},{Details:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsxs)(n.h1,{id:"run-logic-app-workflows-in-sequence-by-indexing-with-the-sequence-controller",children:["Run Logic App workflows in sequence by indexing with the ",(0,r.jsx)("u",{children:"Sequence Controller"})]})}),"\n",(0,r.jsxs)(n.admonition,{title:"motivation",type:"note",children:[(0,r.jsxs)(n.p,{children:["Some dependent external systems can't handle parallel message processing or requires a certain order of messages. Sending messages serially (for example, by setting the concurrency on a Logic App to ",(0,r.jsx)(n.code,{children:"1"}),") can be a solution, at the cost of a big performance impact."]}),(0,r.jsxs)(n.p,{children:["\ud83c\udf0d ",(0,r.jsx)(n.strong,{children:"A customer story from the trenches"})," ",(0,r.jsx)("br",{}),"\n",(0,r.jsxs)(n.em,{children:["A downstream application cannot handle multiple calls at the same time for the same order ID, by using the ",(0,r.jsx)(n.strong,{children:"Sequence Controller"})," we are able to make sure that a single call per order ID is done (by using the order ID in the ",(0,r.jsx)(n.code,{children:"sequenceName"}),") and we do not have the use the concurrency option for the Logic App which would dramatically slow down the processing for all messages."]})]}),(0,r.jsxs)(n.p,{children:["The Invictus Framework provides a ",(0,r.jsx)(n.strong,{children:"Sequence Controller"})," component that allows you to process Logic App workflow runs in a specified order. This way, even though workflows might be triggered in parallel, the dependent external system is not overblown with messages."]}),(0,r.jsxs)(n.p,{children:["\ud83d\udd17 See also the ",(0,r.jsx)(n.a,{href:"https://www.enterpriseintegrationpatterns.com/patterns/messaging/MessageSequence.html",children:"Message Sequence"})," integration pattern."]})]}),"\n",(0,r.jsx)(n.h2,{id:"available-endpoints",children:"Available endpoints"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.strong,{children:"Sequence Controller"})," component is available as a HTTP endpoint in your Logic App workflow. To include sequence processing to your workflow, these three HTTP interaction tasks should normally be added:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#%EF%B8%8F-get-sequence-number",children:(0,r.jsx)(n.code,{children:"/api/GetSequenceNumber"})}),": allows the workflow to determine what current position it has in the sequence;"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#-wait-for-sequence",children:(0,r.jsx)(n.code,{children:"/api/WaitForSequence"})}),": allows the workflow to wait its turn, doing the actual work in a ",(0,r.jsx)(n.strong,{children:"Control"})," task;"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#%EF%B8%8F-complete-sequence",children:(0,r.jsx)(n.code,{children:"/api/ConfirmExecutionCompleted"})}),": allows the workflow to signal that the next workflow in the sequence is up."]}),"\n"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["\u26a1 There also exists a ",(0,r.jsx)(n.a,{href:"#-reset-sequence",children:(0,r.jsx)(n.code,{children:"/api/ResetSequence"})})," action that allows admins to externally remove references to old sequences or possibly reuse sequence names."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Pseudo Logic App workflow with Sequence Controller",src:s(9363).A+"",width:"825",height:"709"})}),"\n",(0,r.jsxs)(n.p,{children:["The idea is that workflows are processed in sequence after the ",(0,r.jsx)(n.strong,{children:"Wait"}),". The place between the ",(0,r.jsx)(n.strong,{children:"Wait"})," and ",(0,r.jsx)(n.strong,{children:"Complete"})," task allows you to place your own logic that needs to run in order. If workflow 1 gets triggered before workflow 2, the second workflow will wait for the first workflow."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Pseudo Logic App workflow runs with Sequence Controller",src:s(9998).A+"",width:"1288",height:"226"})}),"\n",(0,r.jsx)(n.h2,{id:"\ufe0f-get-sequence-number",children:"\u2b05\ufe0f Get sequence number"}),"\n",(0,r.jsxs)(n.p,{children:["First step for the Logic App workflow to run in sequence, is to take a number in the line. Doing this requires you to send a HTTP POST request to the ",(0,r.jsx)(n.code,{children:"/api/GetSequenceNumber"})," endpoint of the deployed ",(0,r.jsx)(n.strong,{children:"Sequence Controller"}),"."]}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["This step can be circumvented in some advanced scenarios where you keep track of the order numbers and pass it yourself during the ",(0,r.jsx)(n.a,{href:"#-wait-for-sequence",children:"Wait for sequence"}),"."]})}),"\n",(0,r.jsx)(n.p,{children:"The most simple request body only contains the name of the sequence. This name can be seen as the transactional group that chain all related workflows. Assuming this is the first workflow, it will receive number 1 in the response body; the second workflow will receive number 2, and so forth."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// POST /api/GetSequenceNumber\n{\n  "sequenceName": "<my-sequence-name>",\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The response body containing this counter is required for the next step: ",(0,r.jsx)(n.a,{href:"#-wait-for-sequence",children:"Wait for sequence"})]}),"\n",(0,r.jsxs)(n.admonition,{title:"start later",type:"tip",children:[(0,r.jsxs)(n.p,{children:["If you want to start the sequence at a later point, you can also pass the ",(0,r.jsx)(n.code,{children:"sequenceStart"})," with your own start number. Only make sure that you pass this along subsequent calls."]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// POST /api/GetSequenceNumber\n{\n  "sequenceName": "<my-sequence-name>",\n  "sequenceStart": 10\n}\n'})})]}),"\n",(0,r.jsx)(n.h2,{id:"-wait-for-sequence",children:"\u231b Wait for sequence"}),"\n",(0,r.jsxs)(n.p,{children:["The next step for the Logic App workflow to run in sequence, is to wait its turn. To facilitate this, the counter collected from the previous ",(0,r.jsx)(n.a,{href:"#%EF%B8%8F-get-sequence-number",children:"Get sequence number"})," step is required."]}),"\n",(0,r.jsxs)(n.p,{children:["To make the workflow wait, a HTTP-callback task is required in the workflow. This allows you to pass in a webhook that the deployed ",(0,r.jsx)(n.strong,{children:"Sequence Controller"})," can call when its the workflow's turn to proceed."]}),"\n",(0,r.jsx)(n.p,{children:"The following request needs to be send in this HTTP callback task:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// POST /api/WaitForExecution\n{\n  "sequenceName": "<my-sequence-name>",\n  "counter": @sequenceCounter, // Collected via /api/GetSequenceNumber.\n  "callbackUri": @listCallbackUrl() // Available through the HTTP-callback task.\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\ufe0f-complete-sequence",children:"\u2611\ufe0f Complete sequence"}),"\n",(0,r.jsxs)(n.p,{children:["The final step for the Logic App workflow to run in sequence, is to signal the completion of the item in the sequence. This will allow the next workflow to proceed. To facilitate this, the counter collected from the previous ",(0,r.jsx)(n.a,{href:"#%EF%B8%8F-get-sequence-number",children:"Get sequence number"})," step is required."]}),"\n",(0,r.jsx)(n.p,{children:"To complete the in-sequence work of the workflow, a HTTP task is required that sends this request."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// POST /api/ConfirmExecutionCompleted\n{\n  "sequenceName": "<my-sequence-name>",\n  "currentCounter": @sequenceCounter, // Collected via /api/GetSequenceNumber\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"-reset-sequence",children:"\ud83d\udd04 Reset sequence"}),"\n",(0,r.jsxs)(n.p,{children:["The deployed ",(0,r.jsx)(n.strong,{children:"Sequence Controller"})," allows admins to reset previously stored sequences. This could be useful if certain sequence names should be reused for other purposes, or for cleaning references."]}),"\n",(0,r.jsx)(n.admonition,{type:"danger",children:(0,r.jsxs)(n.p,{children:["This action ",(0,r.jsx)(n.strong,{children:"SHOULD NOT"})," be part of any Logic App workflow as resetting sequences in the middle of processing will result in indefinitely 'hanging' workflow runs."]})}),"\n",(0,r.jsx)(n.p,{children:"Resetting can be done with sending the following request:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// POST /api/ResetSequence\n{\n  "sequenceName": "<my-sequence-name>"\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"customization",children:"Customization"}),"\n",(0,r.jsxs)(t,{children:[(0,r.jsx)("summary",{children:(0,r.jsx)(n.strong,{children:"Related Bicep parameters"})}),(0,r.jsxs)(n.p,{children:["The following Bicep parameters control the inner workings of the ",(0,r.jsx)(n.strong,{children:"Sequence Controller"})," component. See the ",(0,r.jsx)(n.a,{href:"/framework/installation/",children:"release pipeline step of the deployment of the Invictus Framework"})," to learn more."]}),(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Bicep parameter"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"storageAccountName"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"invictus{resourcePrefix}store"})}),(0,r.jsxs)(n.td,{children:["The name of the Azure Storage Account (used by other Framework components as well) where the ",(0,r.jsx)(n.code,{children:"sequencecontroller"})," Azure Blob Storage container will be located where Azure Logic App workflow sequences are stored."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"sequenceControllerScaling"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{ cpuResources: '0.5', memoryResources: '1.0Gi', scaleMaxReplicas: 1, scaleMinReplicas: 0, concurrentRequests: 10 }"})}),(0,r.jsxs)(n.td,{children:["The Container App options to control scaling. See ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/container-apps/scale-app?pivots=container-apps-bicep#custom",children:"scaling rules in Azure Container Apps"}),"."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"sequenceControllerFunctionName"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"inv-${resourcePrefix}-seqcontroller"})}),(0,r.jsxs)(n.td,{children:["The name of the Azure Container App to be created for the ",(0,r.jsx)(n.strong,{children:"Sequence Controller"})," component."]})]})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>i,x:()=>c});var t=s(6540);const r={},o=t.createContext(r);function i(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(o.Provider,{value:n},e.children)}},9363(e,n,s){s.d(n,{A:()=>t});const t=s.p+"assets/images/pseudo-logic-app-w-sequence-controller-d9f76708c7370f251df530c676a2d27b.png"},9998(e,n,s){s.d(n,{A:()=>t});const t=s.p+"assets/images/pseudo-logic-app-workflow-runs-w-sequence-controller-71ab14632d9410a23cfeecd8eeb54700.png"}}]);