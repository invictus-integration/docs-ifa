pr: none

trigger: none

resources:
  pipelines:
    # Name of the pipeline resource inside this workflow. Used to reference the pipeline resources later on (e.g. download artifacts).
  - pipeline: _build
    # Name of the pipeline in Azure Pipelines
    source: 'customer.azure.invictus.framework.build' 
    trigger: true

parameters:
  - name: "Version"
    type: string
    default: "latest"
  - name: "UseBeta"
    type: string
    default: "$false"

pool:
  vmImage: 'ubuntu-latest'

stages: 
- stage: deploy_dev
  displayName: 'Deploy to Development'
  variables:
  - group: infra.tst
  - group: invictus.tst
  jobs:
  - deployment: deploy_development
    displayName: 'Deploy to Development'
    environment: Development
    strategy:
      runOnce:
        deploy:
          steps:
          - download: '_build'
            displayName: Download Artifact
          - template: ./templates/framework-release-steps.yml
            parameters:
              azureSubscription: 'NameOfYourServiceConnection'
              scriptPath: '$(Pipeline.Workspace)/_build/framework/Deploy.ps1'
              deployScriptParameters: '-Version ${{parameters.Version}} -location "West Europe" -UseBeta ${{parameters.UseBeta}} -ACRPath "invictusreleases.azurecr.io" -ACRUsername $(Infra.Environment.ACRUsername) -ACRPassword $(Infra.Environment.ACRPassword) -resourcePrefix $(Infra.Environment.ResourcePrefix) -ArtifactsPath $(Pipeline.Workspace)/_build/framework -ResourceGroupName $(Infra.Environment.ResourceGroup) -VariableGroupName invictus.$(Infra.Environment.ShortName) -devOpsObjectId "$(Infra.DevOps.Object.Id)" -IdentityProviderApplicationId "$(Infra.AzAD.Client.IdentityProviderApplicationId)"  -IdentityProviderClientSecret "$(Infra.AzAD.Client.IdentityProviderClientSecret)" -ContainerAppsEnvironmentLocation "$(Infra.Environment.ContainerAppsEnvironmentLocation)"'
- stage: deploy_tst
  displayName: 'Deploy to Test'
  dependsOn: deploy_dev
  variables:
  - group: infra.tst
  - group: invictus.tst
  jobs:
  - deployment: deploy_tst
    displayName: 'Deploy to Test'
    environment: Test
    strategy:
      runOnce:
        deploy:
          steps:
          - download: '_build'
            displayName: Download Artifact
          - template: ./templates/framework-release-steps.yml
            parameters:
              azureSubscription: 'NameOfYourServiceConnection'
              scriptPath: '$(Pipeline.Workspace)/_build/framework/Deploy.ps1'
              deployScriptParameters: '-Version ${{parameters.Version}} -location "West Europe" -UseBeta ${{parameters.UseBeta}} -ACRPath "invictusreleases.azurecr.io" -ACRUsername $(Infra.Environment.ACRUsername) -ACRPassword $(Infra.Environment.ACRPassword) -resourcePrefix $(Infra.Environment.ResourcePrefix) -ArtifactsPath $(Pipeline.Workspace)/_build/framework -ResourceGroupName $(Infra.Environment.ResourceGroup) -VariableGroupName invictus.$(Infra.Environment.ShortName) -devOpsObjectId "$(Infra.DevOps.Object.Id)" -IdentityProviderApplicationId "$(Infra.AzAD.Client.IdentityProviderApplicationId)"  -IdentityProviderClientSecret "$(Infra.AzAD.Client.IdentityProviderClientSecret)" -ContainerAppsEnvironmentLocation "$(Infra.Environment.ContainerAppsEnvironmentLocation)"'
- stage: deploy_acc
  displayName: 'Deploy to Acceptance'
  dependsOn: deploy_tst
  variables:
  - group: infra.acc
  - group: invictus.acc
  jobs:
  - deployment: deploy_acc
    displayName: 'Deploy to Acceptance'
    environment: Acceptance
    strategy:
      runOnce:
        deploy:
          steps:
          - download: '_build'
            displayName: Download Artifact
          - template: ./templates/framework-release-steps.yml
            parameters:
              azureSubscription: 'NameOfYourServiceConnection'
              scriptPath: '$(Pipeline.Workspace)/_build/framework/Deploy.ps1'
              deployScriptParameters: '-Version ${{parameters.Version}} -location "West Europe" -UseBeta ${{parameters.UseBeta}} -ACRPath "invictusreleases.azurecr.io" -ACRUsername $(Infra.Environment.ACRUsername) -ACRPassword $(Infra.Environment.ACRPassword) -resourcePrefix $(Infra.Environment.ResourcePrefix) -ArtifactsPath $(Pipeline.Workspace)/_build/framework -ResourceGroupName $(Infra.Environment.ResourceGroup) -VariableGroupName invictus.$(Infra.Environment.ShortName) -devOpsObjectId "$(Infra.DevOps.Object.Id)" -IdentityProviderApplicationId "$(Infra.AzAD.Client.IdentityProviderApplicationId)"  -IdentityProviderClientSecret "$(Infra.AzAD.Client.IdentityProviderClientSecret)" -ContainerAppsEnvironmentLocation "$(Infra.Environment.ContainerAppsEnvironmentLocation)"'
- stage: deploy_prd
  displayName: 'Deploy to Production'
  dependsOn: deploy_acc
  variables:
  - group: infra.prd
  - group: invictus.prd
  jobs:
  - deployment: deploy_prd
    displayName: 'Deploy to Production'
    environment: Production
    strategy:
      runOnce:
        deploy:
          steps:
          - download: '_build'
            displayName: Download Artifact
          - template: ./templates/framework-release-steps.yml
            parameters:
              azureSubscription: 'NameOfYourServiceConnection'
              scriptPath: '$(Pipeline.Workspace)/_build/framework/Deploy.ps1'
              deployScriptParameters: '-Version ${{parameters.Version}} -location "West Europe" -UseBeta ${{parameters.UseBeta}} -ACRPath "invictusreleases.azurecr.io" -ACRUsername $(Infra.Environment.ACRUsername) -ACRPassword $(Infra.Environment.ACRPassword) -resourcePrefix $(Infra.Environment.ResourcePrefix) -ArtifactsPath $(Pipeline.Workspace)/_build/framework -ResourceGroupName $(Infra.Environment.ResourceGroup) -VariableGroupName invictus.$(Infra.Environment.ShortName) -devOpsObjectId "$(Infra.DevOps.Object.Id)" -IdentityProviderApplicationId "$(Infra.AzAD.Client.IdentityProviderApplicationId)"  -IdentityProviderClientSecret "$(Infra.AzAD.Client.IdentityProviderClientSecret)" -ContainerAppsEnvironmentLocation "$(Infra.Environment.ContainerAppsEnvironmentLocation)"'
