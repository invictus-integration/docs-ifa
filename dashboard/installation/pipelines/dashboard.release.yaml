pr: none

trigger: none

resources:
  pipelines:
    # Name of the pipeline resource inside this workflow. Used to reference the pipeline resources later on (e.g. download artifacts).
  - pipeline: _build
    # Name of the pipeline in Azure Pipelines
    source: 'customer.azure.invictus.dashboard.build' 
    trigger: true

parameters:
  - name: "Version"
    type: string
    default: "latest"
  - name: "UseBeta"
    type: string
    default: "$false"

pool:
  vmImage: 'ubuntu-latest'

stages: 
- stage: deploy_dev
  displayName: 'Deploy to Development'
  variables:
  - group: infra.dev
  - group: invictus.dev
  - group: invictus.installation
  jobs:
  - deployment: deploy_development
    displayName: 'Deploy to Development'
    environment: Development
    strategy:
      runOnce:
        deploy:
          steps:
          - download: '_build'
            displayName: Download Artifact
          - template: ./templates/dashboard-release-steps.yaml
            parameters:
              azureSubscription: 'NameOfYourServiceConnection'
              scriptPath: '$(Pipeline.Workspace)/_build/dashboard-v2/Deploy.ps1'
              deployScriptParameters: '-Version ${{parameters.Version}} -UseBeta ${{parameters.UseBeta}} -ACRPath "invictusreleases.azurecr.io" -ACRUsername $(Infra.Environment.ACRUsername) -ACRPassword $(Infra.Environment.ACRPassword) -resourcePrefix $(Infra.Environment.ResourcePrefix) -ArtifactsPath $(Pipeline.Workspace)/_build/dashboard-v2 -ResourceGroupName $(Infra.Environment.ResourceGroup) -VariableGroupName invictus.$(Infra.Environment.ShortName) -devOpsObjectId "$(Infra.DevOps.Object.Id)" -AzureActiveDirectoryClientId "$(Infra.AzAD.Client.Id)" -AzureActiveDirectoryTenantId "$(Infra.DevOps.Tenant.Id)" -AzureActiveDirectoryClientSecret "$(Infra.AzAD.Client.Secret)" -AzureActiveDirectoryAudience "$(Infra.AzAd.Audience)" -IdentityProviderApplicationId "$(Infra.AzAD.Client.IdentityProviderApplicationId)"  -IdentityProviderClientSecret "$(Infra.AzAD.Client.IdentityProviderClientSecret)" -PerformSqlDataMigration 0 -isProvisionedCosmos 0 -FlowDataTTLInDays 90 -ContainerAppsEnvironmentLocation "$(Infra.Environment.ContainerAppsEnvironmentLocation)"'

- stage: deploy_tst
  displayName: 'Deploy to Test'
  dependsOn: deploy_dev
  variables:
  - group: infra.tst
  - group: invictus.tst
  - group: invictus.installation
  jobs:
  - deployment: deploy_tst
    displayName: 'Deploy to Test'
    environment: Test
    strategy:
      runOnce:
        deploy:
          steps:
          - download: '_build'
            displayName: Download Artifact
          - template: ./templates/dashboard-release-steps.yaml
            parameters:
              azureSubscription: 'NameOfYourServiceConnection'
              scriptPath: '$(Pipeline.Workspace)/_build/dashboard/Deploy.ps1'
              deployScriptParameters: '-Version ${{parameters.Version}} -UseBeta ${{parameters.UseBeta}} -ACRPath "invictusreleases.azurecr.io" -ACRUsername $(Infra.Environment.ACRUsername) -ACRPassword $(Infra.Environment.ACRPassword) -resourcePrefix $(Infra.Environment.ResourcePrefix) -ArtifactsPath $(Pipeline.Workspace)/_build/dashboard-v2 -ResourceGroupName $(Infra.Environment.ResourceGroup) -VariableGroupName invictus.$(Infra.Environment.ShortName) -devOpsObjectId "$(Infra.DevOps.Object.Id)" -AzureActiveDirectoryClientId "$(Infra.AzAD.Client.Id)" -AzureActiveDirectoryTenantId "$(Infra.DevOps.Tenant.Id)" -AzureActiveDirectoryClientSecret "$(Infra.AzAD.Client.Secret)" -AzureActiveDirectoryAudience "$(Infra.AzAd.Audience)" -IdentityProviderApplicationId "$(Infra.AzAD.Client.IdentityProviderApplicationId)"  -IdentityProviderClientSecret "$(Infra.AzAD.Client.IdentityProviderClientSecret)" -PerformSqlDataMigration 0 -isProvisionedCosmos 0 -FlowDataTTLInDays 90 -ContainerAppsEnvironmentLocation "$(Infra.Environment.ContainerAppsEnvironmentLocation)"'

- stage: deploy_acc
  displayName: 'Deploy to Acceptance'
  dependsOn: deploy_tst
  variables:
  - group: infra.acc
  - group: invictus.acc
  - group: invictus.installation
  jobs:
  - deployment: deploy_acc
    displayName: 'Deploy to Acceptance'
    environment: Acceptance
    strategy:
      runOnce:
        deploy:
          steps:
          - download: '_build'
            displayName: Download Artifact
          - template: ./templates/dashboard-release-steps.yaml
            parameters:
              azureSubscription: 'NameOfYourServiceConnection'
              scriptPath: '$(Pipeline.Workspace)/_build/dashboard/Deploy.ps1'
              deployScriptParameters: '-Version ${{parameters.Version}} -UseBeta ${{parameters.UseBeta}} -ACRPath "invictusreleases.azurecr.io" -ACRUsername $(Infra.Environment.ACRUsername) -ACRPassword $(Infra.Environment.ACRPassword) -resourcePrefix $(Infra.Environment.ResourcePrefix) -ArtifactsPath $(Pipeline.Workspace)/_build/dashboard-v2 -ResourceGroupName $(Infra.Environment.ResourceGroup) -VariableGroupName invictus.$(Infra.Environment.ShortName) -devOpsObjectId "$(Infra.DevOps.Object.Id)" -AzureActiveDirectoryClientId "$(Infra.AzAD.Client.Id)" -AzureActiveDirectoryTenantId "$(Infra.DevOps.Tenant.Id)" -AzureActiveDirectoryClientSecret "$(Infra.AzAD.Client.Secret)" -AzureActiveDirectoryAudience "$(Infra.AzAd.Audience)" -IdentityProviderApplicationId "$(Infra.AzAD.Client.IdentityProviderApplicationId)"  -IdentityProviderClientSecret "$(Infra.AzAD.Client.IdentityProviderClientSecret)" -PerformSqlDataMigration 0 -isProvisionedCosmos 0 -FlowDataTTLInDays 90 -ContainerAppsEnvironmentLocation "$(Infra.Environment.ContainerAppsEnvironmentLocation)"'

- stage: deploy_prd
  displayName: 'Deploy to Production'
  dependsOn: deploy_acc
  variables:
  - group: infra.prd
  - group: invictus.prd
  - group: invictus.installation
  jobs:
  - deployment: deploy_prd
    displayName: 'Deploy to Production'
    environment: Production
    strategy:
      runOnce:
        deploy:
          steps:
          - download: '_build'
            displayName: Download Artifact
          - template: ./templates/dashboard-release-steps.yaml
            parameters:
              azureSubscription: 'NameOfYourServiceConnection'
              scriptPath: '$(Pipeline.Workspace)/_build/dashboard/Deploy.ps1'
              deployScriptParameters: '-Version ${{parameters.Version}} -UseBeta ${{parameters.UseBeta}} -ACRPath "invictusreleases.azurecr.io" -ACRUsername $(Infra.Environment.ACRUsername) -ACRPassword $(Infra.Environment.ACRPassword) -resourcePrefix $(Infra.Environment.ResourcePrefix) -ArtifactsPath $(Pipeline.Workspace)/_build/dashboard-v2 -ResourceGroupName $(Infra.Environment.ResourceGroup) -VariableGroupName invictus.$(Infra.Environment.ShortName) -devOpsObjectId "$(Infra.DevOps.Object.Id)" -AzureActiveDirectoryClientId "$(Infra.AzAD.Client.Id)" -AzureActiveDirectoryTenantId "$(Infra.DevOps.Tenant.Id)" -AzureActiveDirectoryClientSecret "$(Infra.AzAD.Client.Secret)" -AzureActiveDirectoryAudience "$(Infra.AzAd.Audience)" -IdentityProviderApplicationId "$(Infra.AzAD.Client.IdentityProviderApplicationId)"  -IdentityProviderClientSecret "$(Infra.AzAD.Client.IdentityProviderClientSecret)" -PerformSqlDataMigration 0 -isProvisionedCosmos 0 -FlowDataTTLInDays 90 -ContainerAppsEnvironmentLocation "$(Infra.Environment.ContainerAppsEnvironmentLocation)"'
